#!/bin/sh
# postinst script for ossec-hids-server
#
# see: dh_installdeb(1)

set -e

# summary of how this script can be called:
#        * <postinst> `configure' <most-recently-configured-version>
#        * <old-postinst> `abort-upgrade' <new version>
#        * <conflictor's-postinst> `abort-remove' `in-favour' <package>
#          <new-version>
#        * <postinst> `abort-remove'
#        * <deconfigured's-postinst> `abort-deconfigure' `in-favour'
#          <failed-install-package> <version> `removing'
#          <conflicting-package> <version>
# for details, see http://www.debian.org/doc/debian-policy/ or
# the debian-policy package


case "$1" in
    configure)

    DIR=/var/ossec
    GROUP="ossec"
    USER="ossec"
    OSMYSHELL=/sbin/nologin

    if ! getent group | grep -q "^${GROUP}"
    then
        groupadd --system ${GROUP}
    fi
    if ! getent passwd | grep -q "^${USER}"
    then
        useradd -d ${DIR} -s ${OSMYSHELL} -g ${GROUP} ${USER}
    fi

# Default for all directories
chmod -R 550 ${DIR}
chown -R root:${GROUP} ${DIR}

# To the ossec queue (default for agentd to read)
chown -R ${USER}:${GROUP} ${DIR}/queue/ossec
chmod -R 770 ${DIR}/queue/ossec

# For the logging user
chown -R ${USER}:${GROUP} ${DIR}/logs
chmod -R 750 ${DIR}/logs
chmod -R 775 ${DIR}/queue/rids
touch ${DIR}/logs/ossec.log
chown ${USER}:${GROUP} ${DIR}/logs/ossec.log
chmod 664 ${DIR}/logs/ossec.log

chown -R ${USER}:${GROUP} ${DIR}/queue/diff
chmod -R 750 ${DIR}/queue/diff
chmod 740 ${DIR}/queue/diff/* 2>/dev/null || /bin/true

# For the etc dir
chmod 550 ${DIR}/etc
chown -R root:${GROUP} ${DIR}/etc

if [ -e /etc/localtime ]; then
    cp -p /etc/localtime ${DIR}/etc/;
fi

chown root:${GROUP} ${DIR}/etc/internal_options.conf 2> /dev/null || /bin/true
chown root:${GROUP} ${DIR}/etc/local_internal_options.conf 2> /dev/null || /bin/true
chown root:${GROUP} ${DIR}/etc/client.keys 2> /dev/null || /bin/true
chown root:${GROUP} ${DIR}/agentless/*
chown ${USER}:${GROUP} ${DIR}/.ssh
chown -R root:${GROUP} ${DIR}/etc/shared

chmod 550 ${DIR}/etc
chmod 440 ${DIR}/etc/internal_options.conf
chmod 440 ${DIR}/etc/local_internal_options.conf 2> /dev/null || /bin/true
chmod 440 ${DIR}/etc/client.keys 2> /dev/null || /bin/true
chmod -R 770 ${DIR}/etc/shared # ossec must be able to write to it
chmod 550 ${DIR}/agentless/*
chmod 700 ${DIR}/.ssh


# For the /var/run
chmod 770 ${DIR}/var/run
chown root:${GROUP} ${DIR}/var/run

chown root:${GROUP} ${DIR}/bin/util.sh
chmod +x ${DIR}/bin/util.sh

# active response
chmod 755 ${DIR}/active-response/bin/*
chown root:${GROUP} ${DIR}/active-response/bin/*

chown root:${GROUP} ${DIR}/bin/*
chmod 550 ${DIR}/bin/*

# [...]
chown root:${GROUP} ${DIR}/etc/ossec.conf
chmod 440 ${DIR}/etc/ossec.conf


###
#debconf
###
. /usr/share/debconf/confmodule
# server ip from
db_input high ossec-hids-client/serverip || true
db_go
# Check their answer.
db_get ossec-hids-client/serverip
serverip=$RET
sed -i -e "s/SERVERIP/$serverip/" /var/ossec/etc/ossec.conf
# see http://www.fifi.org/doc/debconf-doc/tutorial.html, Troubleshooting
db_stop


    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >22
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
